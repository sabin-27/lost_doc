<?php
require_once "config.php";

$where_clauses = [];
$order_by = "date_event DESC"; // Default sort

// 1. Handle Search Input (Document Name/Owner Name)
if (isset($_GET['search']) && !empty(trim($_GET['search']))) {
    $search_term = mysqli_real_escape_string($conn, trim($_GET['search']));
    // Use LIKE for partial matches
    $where_clauses[] = "(doc_name LIKE '%$search_term%' OR owner_name LIKE '%$search_term%')";
}

// 2. Handle Status Filter
if (isset($_GET['status_filter']) && in_array($_GET['status_filter'], ['Lost', 'Found'])) {
    $status_filter = mysqli_real_escape_string($conn, $_GET['status_filter']);
    $where_clauses[] = "status = '$status_filter'";
}

// 3. Handle Sorting
if (isset($_GET['sort']) && !empty($_GET['sort'])) {
    $sort_option = $_GET['sort'];
    if (in_array($sort_option, ['date_event DESC', 'date_event ASC'])) {
        $order_by = $sort_option;
    }
}

// 4. Build the final SQL query
$sql = "SELECT * FROM documents";

// Add WHERE clause if filters exist
if (!empty($where_clauses)) {
    $sql .= " WHERE " . implode(" AND ", $where_clauses);
}

// Add ORDER BY clause
$sql .= " ORDER BY $order_by";

// Execute the final query
$result = mysqli_query($conn, $sql);

// Check for errors (good for debugging)
if (!$result) {
    die("Error in SQL query: " . mysqli_error($conn));
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocTrack - Document Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <div class="container my-5">
        <h2 class="mb-4 text-center text-success">ðŸ”Ž Track Lost and Found Documents</h2>
        <form method="GET" class="card p-3 mb-4 shadow-sm bg-light">
    <div class="row g-3">
        <div class="col-md-5">
            <input type="text" name="search" class="form-control" placeholder="Search by Document Name or Owner Name" value="<?php echo isset($_GET['search']) ? htmlspecialchars($_GET['search']) : ''; ?>">
        </div>
        <div class="col-md-3">
            <select name="status_filter" class="form-select">
                <option value="">Filter by Status (All)</option>
                <option value="Lost" <?php echo (isset($_GET['status_filter']) && $_GET['status_filter'] == 'Lost') ? 'selected' : ''; ?>>Lost Documents</option>
                <option value="Found" <?php echo (isset($_GET['status_filter']) && $_GET['status_filter'] == 'Found') ? 'selected' : ''; ?>>Found Documents</option>
            </select>
        </div>
        <div class="col-md-2">
            <select name="sort" class="form-select">
                <option value="date_event DESC" <?php echo (isset($_GET['sort']) && $_GET['sort'] == 'date_event DESC') ? 'selected' : ''; ?>>Sort: Newest First</option>
                <option value="date_event ASC" <?php echo (isset($_GET['sort']) && $_GET['sort'] == 'date_event ASC') ? 'selected' : ''; ?>>Sort: Oldest First</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
        </div>
    </div>
</form>
        <div class="table-responsive">
            <table class="table table-striped table-hover mt-4">
                <thead class="table-dark">
                    <tr>
                        <th>Status</th>
                        <th>Document Name</th>
                        <th>Owner Name</th>
                        <th>Date of Event</th>
                        <th>Location</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                    // Check if there are results (rows) returned from the database
                    if (mysqli_num_rows($result) > 0) {
                        // Loop through each row and display data in a table row
                        while($row = mysqli_fetch_assoc($result)) {
                            $status_class = ($row['status'] == 'Lost') ? 'text-danger fw-bold' : 'text-success fw-bold';
                            
                            echo "<tr>";
                            echo "<td class='$status_class'>" . $row['status'] . "</td>";
                            echo "<td>" . $row['doc_name'] . "</td>";
                            echo "<td>" . $row['owner_name'] . "</td>";
                            echo "<td>" . $row['date_event'] . "</td>";
                            echo "<td>" . $row['location'] . "</td>";
                            // New code with two buttons
echo '<td>
        <a href="view_details.php?id=' . $row['id'] . '" class="btn btn-sm btn-info text-white me-1">View Contact</a>
        <a href="edit.php?id=' . $row['id'] . '" class="btn btn-sm btn-warning me-1">Edit</a>
        <a href="delete.php?id=' . $row['id'] . '" class="btn btn-sm btn-danger" onclick="return confirm(\'Are you sure you want to delete this report?\')">Delete</a>
      </td>';
                            echo "</tr>";
                        }
                    } else {
                        echo '<tr><td colspan="6" class="text-center">No documents found in the tracker yet.</td></tr>';
                    }
                    ?>
                </tbody>
            </table>
        </div>
        
    </div>
    <?php mysqli_close($conn); ?>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
